\label[upgrade]\chap Required changes in ORTE

In this chapter, changes required for \glref{ORTE} to be compatible with the version 2.2 of the \glref{RTPS} protocol are discussed. Following is the state of work, where what is \Blue done is blue\Black, \Green working is green\Black, \Red not finished is red \Black and needless for interoperability is black.

\begitems
\Black
* Structure Module
  \begitems\style x
  \Blue
  * Participant (tested)
  * History Cache (tested)
  * Cache Change (tested)
  * Participant Proxy (tested)
  \Green
  * Writer Endpoint (working)
  * Reader Endpoint (working)
  * Reader Proxy (working)
  * Writer Proxy (working)
  \enditems

\Black
* Messages Module
  \begitems\style x
  \Blue
  * Header (tested)
  * Message Receiver (tested)
  * Data (tested)
  * InfoDestination (done)
  * InfoReply (done)
  * InfoSource (done)
  * InfoTimestamp (done)
  * Pad (done)
  \Green
  * AckNack (working)
  * Gap (working)
  * Heartbeat (working)
  \Black
  * DataFrag
  * HeartbeatFrag
  * NackFrag
  \enditems

\Black
* Behavior Module
  \begitems\style x
  \Blue
  * Best-Effort Stateless Writer (tested)
  * Best-Effort Stateless Reader (tested)
  \Red
  * Reliable Stateless Writer (not finished)
  * Reliable Stateful Reader, Writer Proxy (not finished)
  \Black
  * Best-Effort Stateful Writer
  * Reliable Stateful Writer, Reader Proxy
  * Best-Effort Stateful Reader
  \enditems

\Black
* Discovery Module
  \begitems\style x
  \Blue
  * SPDP (tested)
  \Red
  * SEDP (not finished)
  \enditems
\enditems

\Black

In section \ref[orte:spec], specific types used in \glref{ORTE} are introduced, their purpose and legacy of previous implementation. In \ref[orte:struct], \ref[orte:message], \ref[orte:behavior] and \ref[orte:discovery], implementation of each module from chapter \ref[compare] is discussed. Proposal of consequential development is introduced in section \ref[orte:next].

\label[orte:spec]\sec ORTE specific

\secc Version 1.0

In \glref{RTPS} 1.0 implementation, the core structure is "ORTEDomain". Following are specific types contained in "ORTEDomain" structure:
\begitems
* "TaskProp"
* "TypeEntry"
* "ObjectEntry"
* "PSEntry"
* "CSTPublications"
* "CSTSubscriptions"
\enditems

"TaskProp" maintains properties of {\em Tasks}, including own socket, thread and "MessageBuffer" (used for sending and receiving data) for each {\em Task}. There are five {\em Tasks}: "taskRecvUnicastMetatraffic", "taskRecvMulticastMetatraffic", "taskRecvUnicastUserdata", "taskRecvMulticastUserdata" and "taskSend".

"TypeEntry" is database of {\em Types} used for data encapsulation, containing name of {\em Type} and functions to serialize and deserialize it.

The database of all ``endpoints'' is stored in "ObjectEntry". In "ORTEDomain", variable "objectEntry" of type "ObjectEntry" is the root of 3-layered AVL tree (\cite[www:ulan]), where each layer correspond to {\em Host Id}, {\em Application Id} and {\em Object Id}. Also, {\em Application Id} layer serves as the root for {\em Hierarchical Timer} (\cite[www:ulan]) used for timing in \glref{ORTE}.

"PSEntry", "CSTPublications" and "CSTSubscriptions" are databases of {\em Publications} and {\em Subscriptions}. In context of version 1.0 of the \glref{RTPS} protocol, ``endpoints'' used for user data communication are stored here.

Builtin ``endpoints'' are defined directly in "ORTEDomain" structure, there are nine of {\em CSTWriters} and {\em CSTReaders} used for \glref{CST} protocol:
\begitems
* "writerApplicationSelf"
* "readerManagers"
* "readerApplications"
* "writerManagers"
* "writerApplications"
* "writerPublications"
* "readerPublications"
* "writerSubscriptions"
* "readerSubscriptions".
\enditems

\secc Version 2.2

Domain is abstract term involving communication of nodes that have something in common. The core structure in implementation of version 2.2 of \glref{RTPS} protocol was therefore renamed to "ORTEDomainParticipant". Following types persisted:
\begitems
* "TaskProp"
* "TypeEntry"
* "ObjectEntry"
\enditems

"TaskProp" has the same purpose as in previous implementation, just some of names changed to be more appropriate (see below).

"TypeEntry" remains completely same.

Because of substitution of {\em Host Id} and {\em Application Id} for {\em Guid Prefix}, "ObjectEntry" changed from 3-layered to 2-layered AVL tree (\cite[www:ulan]), where the first layer corresponds to {\em Guid Prefix} and the second one to {\em Entity Id}. The root for {\em Hierarchical Timer} (\cite[www:ulan]) is at the {\em Guid Prefix} layer.

"ORTEEndpoint" structure was added to "ObjectEntry" at the {\em Entity Id} layer. "ORTEEndpoint" can be {\em Stateless Writer} or {\em Stateless Reader} at present (see \ref[upgrade]) and {\em Stateful Writer}, {\em Stateful Reader}, {\em Participant Proxy}, {\em Reader Proxy} and {\em Writer Proxy} will be added in the future. So one database containing all {\em Endpoints} in {\em Domain} is used for each {\em Participant} and there is no need for directly defined {\em Endpoints} or separate database of publishers and subscribers.

\label[orte:struct]\sec Structure Module

\secc Participant

In the correspondence to \glref{PIM} (\ref[struct]) and as mentioned above, "ORTEDomain" structure changed to "ORTEDomainParticipant":
\begtt
struct ORTEDomainParticipant {
  uint32_t                    domainId;
  ObjectEntryEID              *myself;
  uint32_t                    participantId;

  GUID_RTPS                   guid;
  ProtocolVersion             protocolVersion;
  VendorId                    vendorId;

  Locator                     *defaultUnicastLocatorList;
  uint32_t                    defaultUnicastNumLocators;
  Locator                     *defaultMulticastLocatorList;
  uint32_t                    defaultMulticastNumLocators;
  Locator                     *sendingLocator;
  uint32_t                    sendingNumLocators;

  TaskProp                    taskRecvUnicastDiscoveryTraffic;
  TaskProp                    taskRecvMulticastDiscoveryTraffic;
  TaskProp                    taskRecvUnicastUserTraffic;
  TaskProp                    taskRecvMulticastUserTraffic;
  TaskProp                    taskSend;

  TypeEntry                   typeEntry;
  ObjectEntry                 objectEntry;
};
\endtt

Identifiers of "ORTEDomainParticipant" are "domainId", "participantId" and "guid", where "guid" is generated as discussed in \cite[www:github]. The version of implementation is stored in "protocolVersion" attribute and the vendor of implementation in "vendorId" attribute. HERE CONTINUE

The following functions are introduced for the "ORTEDomainPariticipant":

\begitems
* "ORTEDomainRecvThreadStart"
* "ORTEDomainSendThreadStart"
* "ORTEDomainRecvThreadStop"
* "ORTEDomainSendThreadStop"
* "ORTEDomainParticipant_new"
* "ORTEDomainParticipant_start"
* "ORTEDomainParticipant_destroy"
\enditems

Where
\begitems\style x
* "ORTEDomainRecvThreadStart"
* "ORTEDomainSendThreadStart"
* "ORTEDomainRecvThreadStop"
* "ORTEDomainSendThreadStop"
\enditems
functions have the same purpose as in version 1.0 implementation, therefore there are no changes.

The "ORTEDomainParticipant_new" function can be compared to "ORTEDomainCreate". Both return core structure ("ORTEDomainParticipant" in version 2.2 and "ORTEDomain" in version 1.0) and initialize core attributes, structures and tasks.

The "ORTEDomainParticipant_start" function can be compared to "ORTEDomainStart". Both are used to start threads for corresponding {\em Tasks}.

The "ORTEDomainParticipant_destroy" function can be compared to "ORTEDomainDestory". Both are used to release sources related to core structure ("ORTEDomainParticipant" or "ORTEDomain").

\secc Endpoints

Because {\em CSTWriter} evolves to {\em Stateful Writer} and {\em CSTReader} to {\em Stateful Reader}, new structures "StatelessWriter" and "StatelessReader" are introduced in correspondence to reference implementation.

{\em Cache Change} is replacement of {\em CSChange} and is used as ``transfer unit'' for all exchanges in \glref{RTPS} 2.2.

The implementation of {\em History Cache} remains the same - it's implemented as {\em List} (\cite[www:ulan]). This manner allows to save memory by maintaining only one {\em Cache Change}, pointed from more structures as multiple matched {\em Reader Proxy} or {\em Writer Proxy}.

While the name changed for {\em CSTRemote Reader} and {\em CSTRemoteWriter} to {\em Reader Proxy} respective {\em Writer Proxy}, the function of this {\em Endpoints} remains the same.

\label[orte:message]\sec Messages Module

Because of substitution of {\em Host Id} and {\em Application Id} for {\em Guid Prefix} (\ref[rtps10]), the {\em Header} of \glref{RTPS} messages has changed appropriately - instead of 4B for {\em Host Id} and 4B for {\em Application Id}, 12B for {\em Guid Prefix} are sent. The {\em Header} length is therefore resized to 20B.

For {\em Submessages}, new structure "SubmessageHeader" is defined. When {\em Submessages} are sent, predefined macro "PUT_SHEADER(submessageHeader)" ensures putting the {\em Submessage Header} ``on the wire'' in contrast to version 1.0 implementation, where local variables "flags", "len", "length" and global structure "SubmessageId" were used. When receiving, {\em Submessage Header} is got ``from the wire'' only once in the thread of the receiving task. The pointer to "SubmessageHeader" and other pointers to "MessageInterpret" and "CDR_Codec" structures are then forwarded to the {\em Process} function of particular {\em Submessage}, preventing rewinding of "CDR_Codec"'s buffer and reading {\em Submessage Header}'s information again.

According to {\em Guid Prefix} and {\em Locator} changes (\ref[rtps10]), "MessageInterpret" structure has changed - {\em Host Id} and {\em Application Id} are substituted by {\em Guid Prefix} and {\em Reply IP Addresses} are substituted by {\em Reply Locators Lists}.

Generally for {\em Submessages}, name of the function responsible for processing of {\em Submessage} has changed by adding "Process" to the name (e.g. "RTPSInfoDST" function name changed to "RTPSInfoDSTProcess").

According to \ref[rtps10], changes in {\em Interpreter Submessages} cover replacement of {\em Host Id} and {\em Application Id} by {\em Guid Prefix} and corresponding processing and updating of {\em Message Interpret}.



\label[orte:behavior]\sec Behavior Module

\label[orte:discovery]\sec Discovery Module

\label[orte:next]\sec Next Steps

MessageInterpret -> MessageReceiver

